# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2.1

orbs:
  snyk: snyk/snyk@0.0.8
  clair_scanner: ovotech/clair-scanner@1.5.0

jobs:
  scan_image:
    executor: clair_scanner/default
    environment:
      IMAGE_NAME: movie-analyst/api
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build Docker image
          command: docker build -t $IMAGE_NAME:latest .
      - clair_scanner/scan:
          image: $IMAGE_NAME:latest
      - snyk/scan:
          docker-image-name: '$IMAGE_NAME:latest'
          fail-on-issues: false
          monitor-on-build: true
          project: '${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BRANCH}-container'
          target-file: Dockerfile
          token-variable: SNYK_TOKEN
      - persist_to_workspace:
          root: .
          paths:
            - server.js 
            - package.json
            - test/*
  app-build:
    docker:
      # specify the version you desire here
      - image: circleci/node:12.10
    working_directory: ~/movie-analyst-api
    environment:
      IMAGE_NAME: movie-analyst/api
    steps:
      - attach_workspace:
          at: .
      # Download and cache dependencies
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-
      - run: 
          name: Install dependencies
          command: yarn install
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}
      - snyk/scan:
          fail-on-issues: false
          monitor-on-build: true
          project: '${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BRANCH}-app'
          token-variable: SNYK_TOKEN         
      - run: 
          name: run tests!
          command: yarn test
      - run: 
          name: Create the artifact
          command: zip -r /tmp/movie_analyst-api-${CIRCLE_SHA1}.zip node_modules/ server.js package.json

workflows:
  version: 2.1
  main:
    jobs:
      - scan_image:
          context: snyk
      - app-build:
          requires:
            - scan_image
          context: snyk
